{% extends 'arduino/base.html' %}

{% block title %}Administrar Plantas{% endblock %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3">Administrar Plantas</h1>
  </div>



    <!-- Nav tabs to separate Plants and Categories management -->
    <ul class="nav nav-tabs mb-3" id="adminTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="plants-tab" data-bs-toggle="tab" data-bs-target="#plants" type="button" role="tab" aria-controls="plants" aria-selected="true">Plantas</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="categories-tab" data-bs-toggle="tab" data-bs-target="#categories" type="button" role="tab" aria-controls="categories" aria-selected="false">Categorías</button>
      </li>
    </ul>

    <div class="tab-content" id="adminTabsContent">
      <div class="tab-pane fade show active" id="plants" role="tabpanel" aria-labelledby="plants-tab">
        <div class="card mb-4">
          <div class="card-body">
            <h5 class="card-title">Crear nueva planta</h5>
            <form method="post">
              {% csrf_token %}
              <div class="mb-3">
                <label class="form-label">Nombre</label>
                <input class="form-control" type="text" name="name" required />
              </div>
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label class="form-label">Humedad mínima (%)</label>
                  <input class="form-control" type="number" step="0.1" name="humidity_min" placeholder="20.0" />
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">Humedad máxima (%)</label>
                  <input class="form-control" type="number" step="0.1" name="humidity_max" placeholder="60.0" />
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">URL de la imagen</label>
                <input class="form-control" type="text" name="image_url" />
              </div>
              <div class="row">
                <div class="col-md-8 mb-3">
                  <label class="form-label">Categoría</label>
                  <select class="form-select" name="category_id">
                    <option value="">(sin categoría)</option>
                    {% for cat in categories %}
                      <option value="{{ cat.id }}">{{ cat.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">Ubicación</label>
                  <select class="form-select" name="category_location">
                    <option value="BOTH" selected>Ambas</option>
                    <option value="INDOOR">Interior</option>
                    <option value="OUTDOOR">Exterior</option>
                  </select>
                </div>
              </div>
              <button class="btn btn-primary" type="submit">Crear planta</button>
            </form>
          </div>
        </div>

        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Plantas existentes</h5>
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Imagen</th>
                    <th>Categorías</th>
                    <th>Humedad mín./máx.</th>
                    <th>Creada</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  {% for plant in plants %}
                    <tr>
                      <td>{{ plant.name }}</td>
                      <td>
                        {% if plant.image_url %}
                          <img src="{{ plant.image_url }}" alt="{{ plant.name }}" style="max-width:80px;max-height:80px;object-fit:cover;" />
                        {% else %}
                          <span class="text-muted">(sin imagen)</span>
                        {% endif %}
                      </td>
                      <td>
                        {% for cat in plant.categories.all %}
                          <span class="badge bg-secondary">{{ cat.name }}</span>
                        {% empty %}
                          <span class="text-muted">(sin categorías)</span>
                        {% endfor %}
                      </td>
                      <td>{{ plant.humidity_min }}% / {{ plant.humidity_max }}%</td>
                      <td>{{ plant.created_at }}</td>
                      <td>
                        <a class="btn btn-sm btn-outline-secondary" href="{% url 'arduino:edit-plant' plant.pk %}">Editar</a>
                        <form method="post" action="{% url 'arduino:delete-plant' plant.pk %}" style="display:inline-block; margin-left:6px;">
                          {% csrf_token %}
                          <button class="btn btn-sm btn-outline-danger" type="submit" onclick="return confirm('¿Eliminar planta?');">Borrar</button>
                        </form>
                      </td>
                    </tr>
                  {% empty %}
                    <tr>
                      <td colspan="6">Aún no hay plantas.</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="categories" role="tabpanel" aria-labelledby="categories-tab">
        <div class="card mb-4">
          <div class="card-body">
            <h5 class="card-title">Gestionar categorías</h5>
            <form method="post" action="{% url 'arduino:create-category' %}" class="row g-2 align-items-end">
              {% csrf_token %}
              <div class="col-md-10">
                <label class="form-label">Nombre de categoría</label>
                <input class="form-control" type="text" name="category_name" placeholder="árbol, suculenta" />
              </div>
              <div class="col-md-2">
                <button class="btn btn-secondary w-100" type="submit">Crear</button>
              </div>
            </form>

            <hr />
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  {% for cat in categories %}
                    <tr>
                      <td>{{ cat.name }}</td>
                      <td style="width:120px;">
                        <form method="post" action="{% url 'arduino:delete-category' cat.pk %}" style="display:inline-block;">
                          {% csrf_token %}
                          <button class="btn btn-sm btn-outline-danger" type="submit" onclick="return confirm('¿Eliminar categoría?');">Borrar</button>
                        </form>
                      </td>
                    </tr>
                  {% empty %}
                    <tr><td colspan="2">No hay categorías.</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  
{% endblock %}
